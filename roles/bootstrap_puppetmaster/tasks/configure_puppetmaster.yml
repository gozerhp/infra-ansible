---
# Install puppetmaster packages
- apt: name={{ item }} state=installed
  with_items:
    - puppetmaster-passenger
    - hiera
    - hiera-puppet

# Puppet apply the puppetmaster manifest
- command: > 
    puppet apply --modulepath='/opt/system-config/production/modules:/etc/puppet/modules'
    -e 'class {"openstack_project::puppetmaster"':' 
    puppetmaster_server => "{{ inventory_hostname }}",
    puppetdb => false }'
  tags: puppet_apply

- service: name=puppet enabled=yes state=started

# Trigger a puppet agent --test to apply config from repo
- command: puppet agent --test
  ignore_errors: True
